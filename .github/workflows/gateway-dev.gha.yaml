on:
  push:
    branches:
      - master

name: Build and deploy

env:
  PROJECT: wp-hexly-utils
  PLUGIN_FILE: wp-hexly-utils.php

jobs:
  build:
    name: Build
    # needs: prepare
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Generate Build Number
      id: gen-build-num
      env:
        REF: ${{ github.sha }}
        BUILD_NUMBER: ${{ github.run_number }}
      run: |
        CMD="cat $PLUGIN_FILE | grep 'Version:' -m1 | awk '{print \$2}' | sed -e 's/__build-number__/$BUILD_NUMBER.${REF::8}/'"
        echo "Running $CMD"
        VERSION=$(bash -c "$CMD")
        echo "::set-output name=build_version::$VERSION"

    - name: Composer install
      uses: docker://composer:1.9.1
      with:
        args: install

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          BUILD_VERSION: ${{ steps.gen-build-num.outputs.build_version }}
      run: |
        sed -i -e "s/Version: .*__build-number__/Version: ${BUILD_VERSION}/" ./$PLUGIN_FILE
        cat ./$PLUGIN_FILE
        aws s3 ls
        ls -alh
        BASE_DIR=$(pwd)
        ZIP="$BASE_DIR/$PLUGIN/$BUILD_VERSION.zip"
        echo "Here we go: $ZIP $BASE_DIR $PLUGIN $BUILD_VERSION"
        bash build/zip.sh "$ZIP" "$BASE_DIR" "$PLUGIN" "$BUILD_VERSION"
        echo "Done building?"